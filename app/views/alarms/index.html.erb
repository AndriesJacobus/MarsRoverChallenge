
<h3><u>Alarms and State Updates:</u></h3>

<% if (current_user.usertype == "Sysadmin" || current_user.usertype == "Client Admin") %>
  <% if @alarms.size >= 1 %>
    <div style = "margin-top: 15px; margin-bottom: 25px; display: inline-block;">
      <%# <p style = "font-size: 18px;">Alarm Actions:</p>
      <hr style = "display: block; height: 1px; width: 95%; border: 0; border-top: 1px solid #ccc; margin: 1em 0; padding: 0;"/> %>

      <%= link_to 'Acknowledge all Alarms', acknowledge_all_alarms_path, method: :post, data: { confirm: 'Are you sure?' }, class: "waves-effect waves-light blue lighten-1 btn-small white-text" %>
      <%= link_to 'Delete all Entries', delete_all_alarms_path, method: :delete, data: { confirm: 'Are you sure?' }, class: "waves-effect waves-light blue lighten-1 btn-small white-text" %>
    </div>
  <% else %>
    <div style = "margin-top: 15px; margin-bottom: 25px; display: inline-block;">
      <%= link_to 'Acknowledge all Alarms', acknowledge_all_alarms_path, method: :post, data: { confirm: 'Are you sure?' }, class: "waves-effect waves-light gray disabled lighten-1 btn-small white-text" %>
      <%= link_to 'Delete all Entries', delete_all_alarms_path, method: :delete, data: { confirm: 'Are you sure?' }, class: "waves-effect waves-light gray disabled lighten-1 btn-small white-text" %>
    </div>
  <% end %>
<% end %>

<div class = "z-depth-5 hoverable scroller">
  <table>
    <thead>
      <tr>
        <th style = "white-space: nowrap; padding-right: 35px;">Date Triggered</th>
        <th style = "white-space: nowrap; padding-right: 35px;">Is Alarm</th>
        <th style = "white-space: nowrap; padding-right: 35px;">Acknowledged</th>
        <th style = "white-space: nowrap; padding-right: 35px;">Associated Site</th>
        <th style = "white-space: nowrap; padding-right: 35px;">Associated Group</th>
        <th style = "white-space: nowrap; padding-right: 35px;">Associated Device</th>
        <th style = "white-space: nowrap; padding-right: 35px;">Associated Message</th>
        <th style = "white-space: nowrap; padding-right: 35px;">Original Device State</th>
        <th style = "white-space: nowrap; padding-right: 35px;">Device State Changed To</th>
        <th style = "white-space: nowrap; padding-right: 35px;">Reason</th>
        <th style = "white-space: nowrap; padding-right: 35px;">Note</th>
        <th style = "white-space: nowrap; padding-right: 35px;">Acknowledged By</th>
        <th style = "white-space: nowrap; padding-right: 35px;">Date acknowledged</th>
        <th colspan="3"></th>
      </tr>
    </thead>

    <tbody>
      <% @alarms.each do |alarm| %>
        <tr>
          <td style = "padding-right: 35px;"><%= alarm.created_at %> </td>

          <td style = "padding-right: 35px;">
            <% if alarm.state_change_from.downcase.include?("alarm") %>
              <p style = "color: red">Yes</p>
            <% else %>
              <p style = "color: green">No</p>
            <% end %>
          </td>

          <td style = "padding-right: 35px;">
            <% if alarm.acknowledged %>
              <p style = "color: green;">Yes</p>
            <% else %>
              <p style = "color: red;">No</p>
            <% end %>
          </td>

          <td style = "padding-right: 35px;">
            <% if !alarm.device.nil? && !alarm.device.client_group.nil? && !alarm.device.client_group.client.nil? %>
              <%= alarm.device.client_group.client.Name %>
            <% else %>
              N/A
            <% end %>
          </td>

          <td style = "padding-right: 35px;">
            <% if !alarm.device.nil? && !alarm.device.client_group.nil? %>
              <%= alarm.device.client_group.Name %>
            <% else %>
              N/A
            <% end %>
          </td>


          <td style = "padding-right: 35px;">
            <% if !alarm.device.nil? %>
              <%= alarm.device.Name %>
            <% else %>
              N/A
            <% end %>
          </td>
          <td style = "padding-right: 35px;">
            <% if !alarm.message.nil? %>
              <%= alarm.message.Data %>
            <% else %>
              N/A
            <% end %>
          </td>

          <td style = "padding-right: 35px;">
            <% if !alarm.state_change_from.nil? && alarm.state_change_from != "" %>
              <% if alarm.state_change_from == "online" %>
                <p style = "color: green"><%= alarm.state_change_from %></p>
              <% elsif alarm.state_change_from == "offline" %>
                <p style = "color: grey"><%= alarm.state_change_from %></p>
              <% elsif alarm.state_change_from == "maintenance" %>
                <p style = "color: orange"><%= alarm.state_change_from %></p>
              <% else %>
                <p style = "color: red"><%= alarm.state_change_from %></p>
              <% end %>
            <% else %>
              N/A
            <% end %>
          </td>

          <td style = "padding-right: 35px;">
            <% if !alarm.state_change_to.nil? && alarm.state_change_to != "" %>
              <% if alarm.state_change_to == "online" %>
                <p style = "color: green"><%= alarm.state_change_to %></p>
              <% elsif alarm.state_change_to == "offline" || alarm.state_change_to == "offline acknowledged" %>
                <p style = "color: grey"><%= alarm.state_change_to %></p>
              <% elsif alarm.state_change_to == "maintenance" %>
                <p style = "color: orange"><%= alarm.state_change_to %></p>
              <% else %>
                <p style = "color: red"><%= alarm.state_change_to %></p>
              <% end %>
            <% else %>
              N/A
            <% end %>
          </td>

          <td style = "padding-right: 35px;">
            <% if !alarm.alarm_reason.nil? && alarm.alarm_reason != "" %>
              <%= alarm.alarm_reason %>
            <% else %>
              N/A
            <% end %>
          </td>

          <td style = "padding-right: 35px;">
            <% if !alarm.note.nil? && alarm.note != "" %>
              <%= alarm.note %>
            <% else %>
              N/A
            <% end %>
          </td>

          <td style = "padding-right: 35px;">
            <% if !alarm.user.nil?%>
              <%= alarm.user.name %>
            <% else %>
              N/A
            <% end %>
          </td>

          <td style = "padding-right: 35px;">
            <% if alarm.date_acknowledged%>
              <%= alarm.date_acknowledged %>
            <% else %>
              N/A
            <% end %>
          </td>

          <td><%= link_to 'Show', alarm, class: "waves-effect waves-light blue lighten-1 btn-small white-text" %></td>

          <% if (current_user.usertype == "Sysadmin" || current_user.usertype == "Client Admin") %>
            <td><%= link_to 'Edit', edit_alarm_path(alarm), class: "waves-effect waves-light blue lighten-1 btn-small white-text" %></td>
            <td><%= link_to 'Delete', alarm, method: :delete, data: { confirm: 'Are you sure?' }, class: "waves-effect waves-light blue lighten-1 btn-small white-text" %></td>
          <% end %>
          
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<br>

<% if current_user.usertype != "Operator" %>
  <%= link_to 'New Alarm', new_alarm_path, class: "waves-effect waves-light blue lighten-1 btn-small white-text" %> |
<% end %>

<%= link_to 'Back to Dashboard', root_path, class: "waves-effect waves-light blue lighten-1 btn-small white-text" %>