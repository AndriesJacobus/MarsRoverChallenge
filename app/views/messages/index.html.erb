
<h3><u>Messages</u></h3>

<% if (current_user.usertype == "Sysadmin" || current_user.usertype == "Client Admin") %>
  <% if @messages.size >= 1 %>
    <div style = "margin-top: 15px; margin-bottom: 25px; display: inline-block;">
      <%= link_to 'Delete all Entries', delete_all_messages_path, method: :delete, data: { confirm: 'Are you sure?' }, class: "waves-effect waves-light blue lighten-1 btn-small white-text" %>
    </div>
  <% else %>
    <div style = "margin-top: 15px; margin-bottom: 25px; display: inline-block;">
      <%= link_to 'Delete all Entries', delete_all_messages_path, method: :delete, data: { confirm: 'Are you sure?' }, class: "waves-effect waves-light gray disabled lighten-1 btn-small white-text" %>
    </div>
  <% end %>
<% end %>

<div class = "z-depth-5 hoverable scroller">
  <table>
    <thead>
      <tr>
        <th>Time</th>
        <th style = "white-space: nowrap; padding-left: 25px;">Raw Data</th>
        <th style = "white-space: nowrap; padding-left: 35px;">Message Data</th>
        <th style = "white-space: nowrap; padding-left: 25px; white-space: nowrap;">Has Wi-I-Cloud Device</th>
        <th style = "white-space: nowrap; padding-left: 25px; white-space: nowrap;">Wi-I-Cloud Device Name</th>
        <th style = "white-space: nowrap; padding-left: 25px;">Sigfox Device ID</th>
        <th style = "white-space: nowrap; padding-left: 25px;">Sigfox Type ID</th>
        <th colspan="3"></th>
      </tr>
    </thead>

    <tbody>
      <% @messages.each do |message| %>
        <tr>
          <td>
            <%= "#{DateTime.strptime("#{message.Time}",'%s').to_s[0..9]} #{DateTime.strptime("#{message.Time}",'%s').to_s[11..18]} UTCÂ±00:00" %>
          </td>
          <td style = "padding-left: 25px;"><%= message.Data %></td>

          <td style = "white-space: nowrap; padding-left: 35px;">
            Sequence:
            <%= message.Data.to_s[2...4].to_i(16) %>
            <br/><br/>

            Type:
            <% if message.Data.to_s[0...2] == "52" %>
              Triggered Message
            <% else %>
              Keepalive
            <% end %>
            <br/><br/>
            
            Alarm:
            <% m = message.Data.to_s[13...14] %>
            <% m = m.hex.to_s(2).rjust(m.size*4, '0') %>

            <% if m.to_s[0...2] == "00" %>
              Legacy Alarm
            <% elsif m.to_s[0...2] == "01" %>
              Climb Alarm
            <% elsif m.to_s[0...2] == "10" %>
              Cut Alarm
            <% elsif m.to_s[0...2] == "11" %>
              Climb and Cut Alarm
            <% end %>
          </td>

          <td style = "padding-left: 25px;"><%= !message.device.nil? %></td>

          <% if message.device %>
            <td style = "padding-left: 25px;"><%= message.device.Name %></td>
          <% else %>
            <td style = "padding-left: 25px;"><i>N/A</i></td>
          <% end %>

          <td style = "padding-left: 25px; padding-right: 75px;"><%= message.sigfox_defice_id %></td>
          <td style = "padding-left: 25px;"><%= message.sigfox_device_type_id %></td>
          <td style = "padding-left: 25px;"><%= link_to 'Show', message, class: "waves-effect waves-light blue lighten-1 btn-small white-text" %></td>
          <td><%= link_to 'Edit', edit_message_path(message), class: "waves-effect waves-light blue lighten-1 btn-small white-text" %></td>
          <td><%= link_to 'Delete', message, method: :delete, data: { confirm: 'Are you sure?' }, class: "waves-effect waves-light blue lighten-1 btn-small white-text" %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<br>

<%= link_to 'New Message', new_message_path, class: "waves-effect waves-light blue lighten-1 btn-small white-text" %> |
<%= link_to 'Back to Dashboard', root_path, class: "waves-effect waves-light blue lighten-1 btn-small white-text" %>